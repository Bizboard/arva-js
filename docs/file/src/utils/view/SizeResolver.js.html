<!DOCTYPE html>
<html>
<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet"><head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">src/utils/view/SizeResolver.js | Arva API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
<link data-ice="userStyle" rel="stylesheet" href="user/css/0-styles.css">
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  <a href="./manual/overview/tutorial.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">components</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/DataBoundScrollView.js~DataBoundScrollView.html">DataBoundScrollView</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/Dialog.js~Dialog.html">Dialog</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/ReflowingScrollView.js~ReflowingScrollView.html">ReflowingScrollView</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">components/logic/branding</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/logic/branding/BrandingEngine.js~BrandingEngine.html">BrandingEngine</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/logic/branding/BrandingEngineSingleton.js~BrandingEngineSingleton.html">BrandingEngineSingleton</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">core</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core/App.js~App.html">App</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core/Controller.js~Controller.html">Controller</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core/Model.js~Model.html">Model</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core/Router.js~Router.html">Router</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core/View.js~View.html">View</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">data</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/data/DataSource.js~DataSource.html">DataSource</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/data/PrioritisedArray.js~PrioritisedArray.html">PrioritisedArray</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/data/PrioritisedObject.js~PrioritisedObject.html">PrioritisedObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/data/Snapshot.js~Snapshot.html">Snapshot</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">data/datasources</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/data/datasources/FirebaseDataSource.js~FirebaseDataSource.html">FirebaseDataSource</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/data/datasources/SharePointDataSource.js~SharePointDataSource.html">SharePointDataSource</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">data/datasources/SharePoint</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/data/datasources/SharePoint/DataModelGenerator.js~DataModelGenerator.html">DataModelGenerator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/data/datasources/SharePoint/SharePointSnapshot.js~SharePointSnapshot.html">SharePointSnapshot</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">data/datasources/SharePoint/SPSoapAdapter</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/data/datasources/SharePoint/SPSoapAdapter/Settings.js~Settings.html">Settings</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/data/datasources/SharePoint/SPSoapAdapter/SharePoint.js~SharePoint.html">SharePoint</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">data/datasources/SharePoint/SPSoapAdapter/Worker</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/data/datasources/SharePoint/SPSoapAdapter/Worker/SharePointClient.js~SharePointClient.html">SharePointClient</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/data/datasources/SharePoint/SPSoapAdapter/Worker/SoapClient.js~SoapClient.html">SoapClient</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">data/local</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/data/local/LocalModel.js~LocalModel.html">LocalModel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/data/local/LocalPrioritisedArray.js~LocalPrioritisedArray.html">LocalPrioritisedArray</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">data/storage</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/data/storage/FileSource.js~FileSource.html">FileSource</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/data/storage/FirebaseFileSource.js~FirebaseFileSource.html">FirebaseFileSource</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">layout</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/layout/Decorators.js~Event.html">Event</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/layout/Decorators.js~Flow.html">Flow</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/layout/Decorators.js~Layout.html">Layout</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-dynamic">dynamic</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-TrueSizedLayoutDockHelper">TrueSizedLayoutDockHelper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-bindings">bindings</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-event">event</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-flow">flow</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-layout">layout</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-flowStates">flowStates</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-DockTypes">DockTypes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-StickTypes">StickTypes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-StickTypes">StickTypes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-dockBottom">dockBottom</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-dockLeft">dockLeft</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-dockRight">dockRight</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-dockTop">dockTop</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-fill">fill</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">routers</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/routers/ArvaRouter.js~ArvaRouter.html">ArvaRouter</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">surfaces</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/surfaces/Dropdown.js~Dropdown.html">Dropdown</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/surfaces/InputSurface.js~InputSurface.html">InputSurface</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Surface">Surface</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">utils</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/BlobHelper.js~BlobHelper.html">BlobHelper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/DialogManager.js~DialogManager.html">DialogManager</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/Injection.js~Injection.html">Injection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/KeyboardHelper.js~KeyboardHelper.html">KeyboardHelper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/ObjectHelper.js~ObjectHelper.html">ObjectHelper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/Throttler.js~Throttler.html">Throttler</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-callbackToPromise">callbackToPromise</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-successAndErrorToPromise">successAndErrorToPromise</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-waitMilliseconds">waitMilliseconds</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-combineOptions">combineOptions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-limit">limit</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">utils/di</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/di/Decorators.js~ClassProvider.html">ClassProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/di/Decorators.js~FactoryProvider.html">FactoryProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/di/Decorators.js~Inject.html">Inject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/di/Decorators.js~Provide.html">Provide</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/di/Decorators.js~SuperConstructor.html">SuperConstructor</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/di/Decorators.js~TransientScope.html">TransientScope</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/di/Injector.js~Injector.html">Injector</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-annotate">annotate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-hasAnnotation">hasAnnotation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-inject">inject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-provide">provide</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-readAnnotations">readAnnotations</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createProviderFromFnOrClass">createProviderFromFnOrClass</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isFunction">isFunction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isObject">isObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isUpperCase">isUpperCase</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-toString">toString</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ownKeys">ownKeys</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">utils/dialog</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/dialog/DialogWrapper.js~DialogWrapper.html">DialogWrapper</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">utils/hotfixes</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-invalidateLayoutForElement">invalidateLayoutForElement</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">utils/request</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ExistsRequest">ExistsRequest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-GetRequest">GetRequest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-PostRequest">PostRequest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-UrlParser">UrlParser</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ParseStringToXml">ParseStringToXml</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">utils/view</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/view/LayoutHelpers.js~BaseLayoutHelper.html">BaseLayoutHelper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/view/LayoutHelpers.js~DockedLayoutHelper.html">DockedLayoutHelper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/view/LayoutHelpers.js~FullSizeLayoutHelper.html">FullSizeLayoutHelper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/view/LayoutHelpers.js~TraditionalLayoutHelper.html">TraditionalLayoutHelper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/view/OptionObserver.js~OptionObserver.html">OptionObserver</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/view/RenderableHelper.js~RenderableHelper.html">RenderableHelper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/view/SizeResolver.js~SizeResolver.html">SizeResolver</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/view/Utils.js~Utils.html">Utils</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-onOptionChange">onOptionChange</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/utils/view/SizeResolver.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/**
 * Created by lundfall on 01/09/16.
 */

import EventEmitter                 from &apos;eventemitter3&apos;;
import browser                      from &apos;bowser&apos;;

import _unescape                    from &apos;lodash/unescape.js&apos;;
import LayoutUtility                from &apos;famous-flex/LayoutUtility.js&apos;;
import Engine                       from &apos;famous/core/Engine.js&apos;;
import Timer                        from &apos;famous/utilities/Timer.js&apos;;
import {limit}                      from &apos;arva-js/utils/Limiter.js&apos;;

import ImageSurface                 from &apos;famous/surfaces/ImageSurface.js&apos;;
import AnimationController          from &apos;famous-flex/AnimationController.js&apos;;

import {View}                       from &apos;../../core/View.js&apos;;
import {Utils}                      from &apos;./Utils.js&apos;;

import ElementOutput                from &apos;famous/core/ElementOutput&apos;;

/**
 * Used by the view to keep track of sizes. Emits events to communicate with the view to do certain actions
 */
export class SizeResolver extends EventEmitter {

    constructor() {
        super();
        this._resolvedSizesCache = new Map();
        this._sizeIsFinalFor = new Map();
        this._trueSizedSurfaceInfo = new Map();
    }

    /**
     *
     *
     * Determines the decorated size. If there is true sizing involved, then it will not return the resolved true size.
     * Instead, this can be accessed through getResolvedSize()
     * @param {Renderable} renderable. The renderable for which we need the size
     * @param {Renderable} renderableCounterpart. The renderable counter-part (e.g. AnimationController, RenderNode, or ContainerSurface).
     * @param {Object} context. The context, with a specified size. The size can be set to NaN in order to return NaN
     * @param {Array} specifiedSize. The size to use which is specified as a decorator
     * @returns {*}
     */
    settleDecoratedSize(renderable, renderableCounterpart, context, specifiedSize = [undefined, undefined]) {
        let size = specifiedSize.map((size, dimension) =&gt; this.resolveSingleSize(size, context.size, dimension));
        let cacheResolvedSize = [];
        for (let dimension = 0; dimension &lt; 2; dimension++) {
            if (this.isValueTrueSized(size[dimension])) {
                cacheResolvedSize[dimension] = this._resolveSingleTrueSizedRenderable(renderable, size, dimension, renderableCounterpart, specifiedSize, context.size);
                if (Utils.renderableIsSurface(renderable)) {
                    size[dimension] = true;
                } else {
                    size[dimension] = cacheResolvedSize[dimension];
                }
            } else {
                size[dimension] = size[dimension] === undefined ? (context.size[dimension] || size[dimension]) : size[dimension];
                cacheResolvedSize[dimension] = size[dimension];
            }
        }

        this._resolvedSizesCache.set(renderable, [cacheResolvedSize[0], cacheResolvedSize[1]]);

        return (size[0] !== null &amp;&amp; size[1] !== null) ? size : null;
    }

    /**
     * Resolves a single dimension (i.e. x or y) size of a renderable.
     * @param {Number|Boolean|Object|Undefined|Function} renderableSize Renderable&apos;s single dimension size.
     * @param {Array.Number} contextSize The context size
     * @param {Number} dimension The dimension of the size that is being evaluated (e.g. 1 or 0)
     * @returns {Number} The resulting size
     * @private
     */
    resolveSingleSize(renderableSize, contextSize, dimension) {
        switch (typeof renderableSize) {
            case &apos;function&apos;:
                return this.resolveSingleSize(renderableSize(...contextSize), contextSize, dimension);
            case &apos;number&apos;:
                /* If 0 &lt; renderableSize &lt; 1, we interpret renderableSize as a fraction of the contextSize */
                return renderableSize &lt; 1 &amp;&amp; renderableSize &gt; 0 ? renderableSize * Math.max(contextSize[dimension], 0) : renderableSize;
            default:
                /* renderableSize can be true, undefined, or something unkown. */
                return renderableSize;
        }
    }

    /**
     * Resolves a true size to an actual size of a truesized renderable. size[dim] must be negative or true.
     * @param {Renderable} renderable the renderable
     * @param {Array} size the size as specified
     * @param dim the dimensions e.g. 0,1 that should be processed
     * @param {Renderable} renderableCounterpart. The renderable counter-part (e.g. AnimationController, RenderNode, or ContainerSurface).
     * @param {Array} specifiedSize The size as specified
     * @returns {Number} size[dim] will be returned with a non-truesized value
     * @private
     */
    _resolveSingleTrueSizedRenderable(renderable, size, dim, renderableCounterpart, specifiedSize, contextSize) {
        if (size[dim] === -1) {
            Utils.warn(&apos;-1 detected as set size. If you want a true sized element to take &apos; +
                &apos;up a proportion of your view, please define a function doing so by &apos; +
                &apos;using the context size&apos;);
        }
        /* If there is an AnimationController without content, display 0 size */
        if (renderableCounterpart instanceof AnimationController &amp;&amp; !renderableCounterpart._showingRenderable) {
            return 0;
        }
        /* True sized element. This has been specified as ~100 where 100 is the initial size
         * applying this operator again (e.g. ~~100) gives us the value 100 back
         * */
        if (Utils.renderableIsComposite(renderable)) {
            let twoDimensionalSize = renderable.getSize();
            if (!twoDimensionalSize) {
                return this._specifyUndeterminedSingleHeight(renderable, size, dim);
            } else {
                let renderableIsView = renderable instanceof View;
                /* If the renderable isn&apos;t displaying, we must simply consider it final.
                 TODO: There might be better ways to reason about non-displaying renderables  */
                let sizeConsideredFinal = !(renderableIsView &amp;&amp; renderable.layout.isDisplaying()) ||
                    ((renderableIsView &amp;&amp; (renderable._initialised &amp;&amp; !renderable.containsUncalculatedSurfaces())) || !renderableIsView);
                if (size[dim] === true &amp;&amp; twoDimensionalSize[dim] === undefined &amp;&amp; sizeConsideredFinal) {
                    Utils.warn(`True sized renderable &apos;${renderable.constructor.name}&apos; is taking up the entire context size.`);
                    return contextSize[dim];
                } else {
                    let approximatedSize = size[dim] === true ? twoDimensionalSize[dim] : ~size[dim];
                    let resultingSize = twoDimensionalSize[dim] !== undefined ? twoDimensionalSize[dim] : approximatedSize;
                    if (renderableIsView) {
                        resultingSize = sizeConsideredFinal ? resultingSize : approximatedSize;
                    }
                    this._sizeIsFinalFor.set(renderable, sizeConsideredFinal);
                    return resultingSize;
                }
            }
        } else if (Utils.renderableIsSurface(renderable)) {
            let trueSizedSurfaceInfo = this._trueSizedSurfaceInfo.get(renderable);

            if (!trueSizedSurfaceInfo) {
                /* Seems like the surface isn&apos;t properly configured, let&apos;s get that going */
                trueSizedSurfaceInfo = this.configureTrueSizedSurface(renderable, specifiedSize);
            }
            let { isUncalculated, trueSizedDimensions } = trueSizedSurfaceInfo;

            this._sizeIsFinalFor.set(renderable, !isUncalculated);

            if (isUncalculated === false &amp;&amp; trueSizedDimensions[dim]) {
                return trueSizedSurfaceInfo.size[dim];
            }

            if (!trueSizedDimensions[dim]) {
                trueSizedDimensions[dim] = true;
                this._evaluateTrueSizedSurface(renderable);
            }

            if (size[dim] === true) {
                /* If size is set to true, and it can&apos;t be resolved, then settle with size undefined*/
                size[dim] = undefined;
            }

            let approximatedSize = size[dim] === undefined ? contextSize[dim] : ~size[dim];
            /* Return an approximated size, if possible */
            return (trueSizedSurfaceInfo.size[dim] || approximatedSize);
        } else {
            this._sizeIsFinalFor.set(renderable, true);
            return this._specifyUndeterminedSingleHeight(renderable, size, dim);
        }
    }

    async invalidateFontForBrowserBugFix(font) {
        let dummyContext = Engine.getCachedCanvas().getContext(&quot;2d&quot;);
        dummyContext.font = font;
        dummyContext.measureText(&apos;A&apos;);
        await new Promise((resolve) =&gt; Timer.after(resolve, 1));

    }

    _measureRenderableWidth(surface, text = surface.getContent()) {
        /* The canvas API is too unreliable for now */
        if (true) {
            return;
        }
        let surfaceProperties = surface.getProperties();
        let {
            fontStyle = &apos;normal&apos;,
            fontSize = &apos;medium&apos;,
            fontWeight = &apos;normal&apos;,
            fontVariant = &apos;normal&apos;,
            lineHeight = &apos;normal&apos;,
            fontFamily,
            letterSpacing = &apos;0px&apos;,
            font
        } = surfaceProperties;
        if (!font &amp;&amp; fontFamily) {
            font = `${fontStyle} ${fontVariant} ${fontWeight} ${fontSize}/${lineHeight} &quot;${fontFamily}&quot;`;
        }
        if (!font) return;


        let context = Engine.getCachedCanvas().getContext(&quot;2d&quot;);

        if (font) {
            context.font = font;
        }


        let [paddingTop, paddingRight, paddingBottom, paddingLeft] = this._getParsedPadding(surfaceProperties);
        let content = _unescape(text);
        context.measureText(content);
        let textWidth = context.measureText(content).width + content.length * this._cssValueToPixels(letterSpacing, undefined);
        let resultingWidth = this._cssValueToPixels(paddingLeft, textWidth) + textWidth + this._cssValueToPixels(paddingRight, textWidth);
        /* Mozilla Firefox appreciates the values rounded upwards */
        return Math.ceil(resultingWidth);
    }

    _getParsedPadding(properties) {
        let {
            padding,
            paddingRight = &apos;0px&apos;,
            paddingLeft = &apos;0px&apos;,
            paddingTop = &apos;0px&apos;,
            paddingBottom = &apos;0px&apos;
        } = properties;
        if (padding) {
            [paddingTop, paddingRight, paddingBottom, paddingLeft] = LayoutUtility.normalizeMargins(padding.split(&quot; &quot;));
        }
        return [paddingTop, paddingRight, paddingBottom, paddingLeft];
    }

    _estimateRenderableHeight(surface) {
        let surfaceProperties = surface.getProperties();
        let { fontSize, lineHeight } = surface.getProperties();
        if (!fontSize) {
            return NaN;
        }
        let [paddingTop, paddingRight, paddingBottom, paddingLeft] = this._getParsedPadding(surfaceProperties);
        /* If using a percentage in font, it refers to 16px */
        let estimatedHeight;
        if (!surface.getContent()) {
            estimatedHeight = 0;
        } else {
            estimatedHeight = this._cssValueToPixels(fontSize, 16);
        }
        if (lineHeight) {
            estimatedHeight = this._cssValueToPixels(lineHeight, estimatedHeight);
        }
        return this._cssValueToPixels(paddingTop, estimatedHeight) + estimatedHeight + this._cssValueToPixels(paddingBottom, estimatedHeight);
    }

    _cssValueToPixels(value = NaN, parentSize = NaN) {
        if (value.endsWith(&apos;px&apos;)) {
            return parseFloat(value);
        }
        /* Pixels are points times 1 and a third */
        if (value.endsWith(&apos;pt&apos;)) {
            return parseFloat(value) * (1 + 1 / 3);
        }
        if (value === &apos;normal&apos;) {
            return parentSize;
        }

        if (value.endsWith(&apos;%&apos;)) {
            return (parseFloat(value) / 100) * parentSize;
        }
        //value ends with number, assume proportion
        return parseFloat(value) * parentSize;
    }

    /**
     * Determines whether the size is considered final or not, and may affect whether the rendering will take place or
     * not
     * @param {Renderable} renderable
     * @returns {Boolean} sizeIsFinal
     */
    isSizeFinal(renderable) {
        let consideredFinal = this._sizeIsFinalFor.get(renderable);

        /* Return true if nothing is known, to be sure not to make false negatives */
        if (consideredFinal === undefined) {
            return true;
        }
        return consideredFinal;
    }

    /**
     * Determines if the value is true sized
     * @param {*} value
     * @returns {boolean} True if the value is true sized
     * @private
     */
    isValueTrueSized(value) {
        return value &lt; 0 || value === true
    }


    _specifyUndeterminedSingleHeight(renderable, size, dim) {
        let resultingSize = size[dim] &lt; 0 ? ~size[dim] : 5;
        Utils.warn(`Cannot determine size of ${renderable.constructor.name}, falling back to default size or ${resultingSize}px. If the renderable is using legacy declaration this.renderables = ... this isn&apos;t supported for true sizing.`);
        return resultingSize;
    }

    containsUncalculatedSurfaces() {
        for (let [surface, { isUncalculated }] of this._trueSizedSurfaceInfo) {
            if (isUncalculated) {
                return true;
            }
        }
        return false;
    }

    /**
     * Calculates a surface size, if possible
     * @param renderable
     * @returns Boolean True if the surface could be calculated
     * @private
     */
    _tryCalculateTrueSizedSurface(renderable) {
        let renderableHtmlElement = renderable._element;
        if (!renderableHtmlElement) return false;
        let trueSizedInfo = this._trueSizedSurfaceInfo.get(renderable);
        let { trueSizedDimensions } = trueSizedInfo;

        /* HTML treats white space as nothing at all, so we need to be sure that &quot;  &quot; == &quot;&quot; */
        let trimmedContent = (renderable.getContent() &amp;&amp; renderable.getContent().trim) ? renderable.getContent().trim() : renderable.getContent();

        if (renderableHtmlElement &amp;&amp;
            ((
                    renderableHtmlElement.offsetWidth &amp;&amp; renderableHtmlElement.offsetHeight
                ) ||
                (!trimmedContent &amp;&amp; !(renderable instanceof ImageSurface))
            ) &amp;&amp;
            /* If the content is dirty, that means that the content is about to change, so we shouldn&apos;t resolve the size */
            !renderable._contentDirty &amp;&amp;
            (!renderableHtmlElement.style.width || !trueSizedDimensions[0]) &amp;&amp; (!renderableHtmlElement.style.height || !trueSizedDimensions[1])) {
            let newSize;


            newSize = [renderableHtmlElement.offsetWidth, renderableHtmlElement.offsetHeight];

            let oldSize = trueSizedInfo.size;
            let sizeChange = false;
            if (oldSize) {
                for (let i = 0; i &lt; 2; i++) {
                    if (trueSizedDimensions[i] &amp;&amp; oldSize[i] !== newSize[i]) {
                        sizeChange = true;
                    }
                }
            } else {
                sizeChange = true;
            }

            if (sizeChange) {
                trueSizedInfo.size = newSize;
                trueSizedInfo.isUncalculated = false;
            }
            this.requestRecursiveReflow();
            return true;
        } else {
            this.requestReflow();
            this.requestLayoutControllerReflow();
            return false;
        }
    }

    requestRecursiveReflow() {
        this.emit(&apos;reflowRecursively&apos;);
    }

    requestReflow() {
        this.emit(&apos;reflow&apos;);
    }

    requestLayoutControllerReflow() {
        this.emit(&apos;layoutControllerReflow&apos;);
    }

    /**
     * Sets up a true sized surface
     * @param renderable
     * @returns {{isUncalculated: boolean, trueSizedDimensions: boolean[], name: *}} an entry in this._trueSizedSurfaceInfo
     * @private
     */
    configureTrueSizedSurface(renderable, specifiedSize) {
        let trueSizedDimensions = specifiedSize.map((singleSize) =&gt; this.isValueTrueSized(singleSize));
        let trueSizedSurfaceInfo = {
            isUncalculated: true,
            trueSizedDimensions,
            size: [undefined, undefined],
            specifiedSize
        };

        /* We assume both dimensions not to be truesized, they are set in this._resolveDecoratedSize */
        this._trueSizedSurfaceInfo.set(renderable, trueSizedSurfaceInfo);


        this._evaluateTrueSizedSurface(renderable);

        return trueSizedSurfaceInfo;
    }

    /**
     * Investigates the surfaces to see in which way the size should be estimated.
     *
     * Currently disabled due to browser and font difficulties
     * @param renderable
     * @returns {*}
     * @private
     */
    async _evaluateTrueSizedSurface(renderable) {
        //TODO Re-enable the canvas sizing once its been stabilizied
        return this._setupSurfaceGetsSizeFromDOM(renderable);

        let trueSizedSurfaceInfo = this._trueSizedSurfaceInfo.get(renderable);


        if (renderable instanceof ImageSurface) {
            return this._setupSurfaceGetsSizeFromDOM(renderable);
        }

        let [widthExplicitlySet, heightExplicitlySet] = this._determineDimensionsExplicitlySet(renderable);

        if (widthExplicitlySet &amp;&amp; heightExplicitlySet) {
            trueSizedSurfaceInfo.size = [...renderable.size];
            return;
        }

        if (!widthExplicitlySet &amp;&amp; this._doesBrowserNeedBugFixForSurface(renderable)) {
            this._patchCanvasBug(renderable);
            Timer.after(() =&gt; {
                this._calculateTrueSizedSurfaceFromCanvas(renderable);
                this.requestRecursiveReflow();
            }, 1);
            return;
        }

        this._calculateTrueSizedSurfaceFromCanvas(renderable);
    }

    /**
     * Sets up that the surface should estimate its own size by querying the DOM (the less performant option)
     * @param renderable
     * @private
     */
    _setupSurfaceGetsSizeFromDOM(renderable) {


        let trueSizeSurfaceInfo = this._trueSizedSurfaceInfo.get(renderable);
        let { resizeFromCanvasListener, deployFromCanvasListener, trueSizedDimensions } = trueSizeSurfaceInfo;

        /* Need to set the Surface &apos;size&apos; property in order to get resize notifications */
        renderable.setSize(trueSizedDimensions.map((isTrueSized) =&gt; isTrueSized || undefined));

        if (resizeFromCanvasListener) {
            renderable.removeListener(&apos;resize&apos;, resizeFromCanvasListener);
        }
        if (deployFromCanvasListener) {
            renderable.removeListener(&apos;deploy&apos;, deployFromCanvasListener);
        }
        if (!trueSizeSurfaceInfo.resizeFromDOMListener) {
            let resizeListener = trueSizeSurfaceInfo.resizeFromDOMListener = () =&gt; {
                this._tryCalculateTrueSizedSurface(renderable);
                /* Because the resize is triggered before the DOM manipulations happened, also
                 *  try to calculate the surface after 1 more tick */
                Timer.after(() =&gt; this._tryCalculateTrueSizedSurface(renderable), 1);
            };
            renderable.on(&apos;resize&apos;, resizeListener);
        }
        if (!trueSizeSurfaceInfo.deployFromDOMListener) {
            let deployListener = trueSizeSurfaceInfo.deployFromDOMListener = () =&gt; {
                if (!trueSizeSurfaceInfo.isUncalculated) {
                    this._tryCalculateTrueSizedSurface(renderable);
                }
            };
            renderable.on(&apos;deploy&apos;, deployListener);
        }
    }

    /**
     * Sets up that we should estimate the size of the renderable based on the canvas API
     * @param renderable
     * @private
     */
    _setupSurfaceGetsSizeFromCanvas(renderable) {
        let trueSizeSurfaceInfo = this._trueSizedSurfaceInfo.get(renderable);
        renderable.setSize(trueSizeSurfaceInfo.size);
        let { resizeFromDOMListener, deployFromDOMListener } = trueSizeSurfaceInfo;
        if (resizeFromDOMListener) {
            renderable.removeListener(&apos;resize&apos;, resizeFromDOMListener);
        }
        if (deployFromDOMListener) {
            renderable.removeListener(&apos;deploy&apos;, deployFromDOMListener);
        }
        if (!trueSizeSurfaceInfo.resizeFromCanvasListener) {
            let resizeListener = trueSizeSurfaceInfo.resizeFromCanvasListener = () =&gt; {
                this._evaluateTrueSizedSurface(renderable);
                this.requestReflow();
            };
            renderable.on(&apos;resize&apos;, resizeListener);
        }
        if (!trueSizeSurfaceInfo.deployFromCanvasListener) {
            let deployListener = trueSizeSurfaceInfo.deployFromCanvasListener = () =&gt; {
                if (!trueSizeSurfaceInfo.isUncalculated) {
                    /* Reset size. If not reset, it will be interpreted as being explicitly set
                     *  in evaluateTrueSizedSurface */
                    renderable.setSize(null);
                    this._evaluateTrueSizedSurface(renderable);
                    this.requestReflow();
                }
            };
            renderable.on(&apos;deploy&apos;, deployListener);
        }

    }

    /**
     * Gets the size used when displaying a renderable on the screen the last time the calculation was done.
     * @param {Renderable/Name} renderableOrName The renderable or the name of the renderable of which you need the size
     */
    getResolvedSize(renderable) {
        return this._resolvedSizesCache.get(renderable);
    }

    doTrueSizedBookkeeping() {
        for (let [surface] of this._trueSizedSurfaceInfo) {
            /* Encourage the surfaces to check if they have been resized, which could trigger the resize event */
            surface._trueSizeCheck = true;
        }
    }

    getSurfaceTrueSizedInfo(surface) {
        return this._trueSizedSurfaceInfo.get(surface);
    }

    /**
     * For Chrome and Safari, the canvas API doesn&apos;t return the correct value when font is loaded
     * @param renderable
     * @returns {Promise.&lt;void&gt;}
     * @private
     */
    async _patchCanvasBug(renderable) {
        let fontFamily = this._getFontFamilyFromSurface(renderable);
        await this.invalidateFontForBrowserBugFix(fontFamily);
        SizeResolver._invalidatedFonts[fontFamily] = true;

    }

    _doesBrowserNeedBugFixForSurface(surface) {
        if (!browser.check(&apos;webkit&apos;)) {
            return false;
        }
        if (!SizeResolver._invalidatedFonts) {
            SizeResolver._invalidatedFonts = {};
        }

        let fontFamily = this._getFontFamilyFromSurface(surface);

        if (!fontFamily) {
            return true;
        }

        return !SizeResolver._invalidatedFonts[fontFamily];
    }

    _getFontFamilyFromSurface(surface) {
        let properties = surface.getProperties();
        let { fontFamily, font } = properties;
        if (!fontFamily) {
            if (!font) {
                return;
            }
            let fontMatch = /&quot;(.*)&quot;$/g.exec(font);
            if (fontMatch[1]) {
                fontFamily = fontMatch[1];
            } else {
                fontFamily = font.split(&apos; &apos;).slice(-1)[0];
            }
        }
        return fontFamily;
    }

    _calculateTrueSizedSurfaceFromCanvas(renderable) {
        let trueSizedSurfaceInfo = this._trueSizedSurfaceInfo.get(renderable);
        let { trueSizedDimensions, specifiedSize } = trueSizedSurfaceInfo;
        let [widthExplicitlySet, heightExplicitlySet] = this._determineDimensionsExplicitlySet(renderable);

        let estimatedWidth = widthExplicitlySet ?
            renderable.size[0] :
            this._measureRenderableWidth(renderable);


        let height = null, width = null;

        if (trueSizedDimensions[0]) {
            width = trueSizedSurfaceInfo.size[0] = estimatedWidth;
        }

        if (trueSizedDimensions[1]) {
            if (!trueSizedDimensions[0]) {
                let resolvedSpecifiedWidth = this.resolveSingleSize(specifiedSize[0], { size: [NaN, NaN] }, 0);
                if (!resolvedSpecifiedWidth || resolvedSpecifiedWidth &lt; estimatedWidth) {
                    return this._setupSurfaceGetsSizeFromDOM(renderable);
                }
            }
            if (heightExplicitlySet &amp;&amp; !renderable.size) {
                return this._setupSurfaceGetsSizeFromDOM(renderable);
            }
            height = trueSizedSurfaceInfo.size[1] =
                heightExplicitlySet ?
                    renderable.size[1]
                    : this._estimateRenderableHeight(renderable);
        }

        for (let singleSize of [width, height]) {
            if (singleSize === undefined || Number.isNaN(singleSize)) {
                return this._setupSurfaceGetsSizeFromDOM(renderable);
            }
        }

        /* If we reached this far, then everything could succesfully be calculated */
        trueSizedSurfaceInfo.isUncalculated = false;
        /* Keep listening for further changes, if necessary */
        this._setupSurfaceGetsSizeFromCanvas(renderable);
    }

    _determineDimensionsExplicitlySet(surface) {
        return [surface.size &amp;&amp; typeof surface.size[0] === &apos;number&apos;,
            surface.size &amp;&amp; typeof surface.size[1] === &apos;number&apos;];
    }
}</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
