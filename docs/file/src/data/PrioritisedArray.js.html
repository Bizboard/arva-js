<!DOCTYPE html>
<html>
<link href='http://fonts.googleapis.com/css?family=Lato:400,700' rel='stylesheet' type='text/css'><head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/data/PrioritisedArray.js | Arva API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
<link data-ice="userStyle" rel="stylesheet" href="user/css/0-styles.css">
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">components</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/DataBoundScrollView.js~DataBoundScrollView.html">DataBoundScrollView</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/ReflowingScrollView.js~ReflowingScrollView.html">ReflowingScrollView</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">components/logic/branding</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/logic/branding/BrandingEngine.js~BrandingEngine.html">BrandingEngine</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/logic/branding/BrandingEngineSingleton.js~BrandingEngineSingleton.html">BrandingEngineSingleton</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">core</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core/App.js~App.html">App</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core/Controller.js~Controller.html">Controller</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core/Model.js~Model.html">Model</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core/Router.js~Router.html">Router</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core/View.js~View.html">View</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">data</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/data/DataSource.js~DataSource.html">DataSource</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/data/PrioritisedArray.js~PrioritisedArray.html">PrioritisedArray</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/data/PrioritisedObject.js~PrioritisedObject.html">PrioritisedObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/data/Snapshot.js~Snapshot.html">Snapshot</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">data/datasources</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/data/datasources/FirebaseDataSource.js~FirebaseDataSource.html">FirebaseDataSource</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/data/datasources/SharePointDataSource.js~SharePointDataSource.html">SharePointDataSource</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">data/datasources/SharePoint</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/data/datasources/SharePoint/DataModelGenerator.js~DataModelGenerator.html">DataModelGenerator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/data/datasources/SharePoint/SharePointSnapshot.js~SharePointSnapshot.html">SharePointSnapshot</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">data/datasources/SharePoint/SPSoapAdapter</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/data/datasources/SharePoint/SPSoapAdapter/Settings.js~Settings.html">Settings</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/data/datasources/SharePoint/SPSoapAdapter/SharePoint.js~SharePoint.html">SharePoint</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">data/datasources/SharePoint/SPSoapAdapter/Worker</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/data/datasources/SharePoint/SPSoapAdapter/Worker/SharePointClient.js~SharePointClient.html">SharePointClient</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/data/datasources/SharePoint/SPSoapAdapter/Worker/SoapClient.js~SoapClient.html">SoapClient</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">data/local</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/data/local/LocalModel.js~LocalModel.html">LocalModel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/data/local/LocalPrioritisedArray.js~LocalPrioritisedArray.html">LocalPrioritisedArray</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">layout</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-event._subscribe">event._subscribe</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-event.on">event.on</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-event.once">event.once</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-event.pipe">event.pipe</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-layout._dockTo">layout._dockTo</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-layout.align">layout.align</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-layout.animate">layout.animate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-layout.custom">layout.custom</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-layout.dock.bottom">layout.dock.bottom</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-layout.dock.fill">layout.dock.fill</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-layout.dock.left">layout.dock.left</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-layout.dock.none">layout.dock.none</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-layout.dock.right">layout.dock.right</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-layout.dock.top">layout.dock.top</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-layout.dockPadding">layout.dockPadding</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-layout.dockSpace">layout.dockSpace</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-layout.draggable">layout.draggable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-layout.flow">layout.flow</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-layout.fullSize">layout.fullSize</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-layout.opacity">layout.opacity</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-layout.origin">layout.origin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-layout.renderable">layout.renderable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-layout.rotate">layout.rotate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-layout.rotateFrom">layout.rotateFrom</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-layout.scale">layout.scale</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-layout.scrollable">layout.scrollable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-layout.size">layout.size</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-layout.skew">layout.skew</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-layout.swipable">layout.swipable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-layout.translate">layout.translate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-layout.translateFrom">layout.translateFrom</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-TrueSizedLayoutDockHelper">TrueSizedLayoutDockHelper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-event">event</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-flow">flow</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-layout">layout</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-flowStates">flowStates</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">routers</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/routers/ArvaRouter.js~ArvaRouter.html">ArvaRouter</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">utils</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/BlobHelper.js~BlobHelper.html">BlobHelper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/DialogManager.js~DialogManager.html">DialogManager</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/Injection.js~Injection.html">Injection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/KeyboardHelper.js~KeyboardHelper.html">KeyboardHelper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/ObjectHelper.js~ObjectHelper.html">ObjectHelper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/Throttler.js~Throttler.html">Throttler</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-callbackToPromise">callbackToPromise</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-successAndErrorToPromise">successAndErrorToPromise</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-waitMilliseconds">waitMilliseconds</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-combineOptions">combineOptions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-limit">limit</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">utils/di</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/di/Decorators.js~ClassProvider.html">ClassProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/di/Decorators.js~FactoryProvider.html">FactoryProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/di/Decorators.js~Inject.html">Inject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/di/Decorators.js~Provide.html">Provide</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/di/Decorators.js~SuperConstructor.html">SuperConstructor</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/di/Decorators.js~TransientScope.html">TransientScope</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/di/injector.js~Injector.html">Injector</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-annotate">annotate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-hasAnnotation">hasAnnotation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-inject">inject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-provide">provide</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-readAnnotations">readAnnotations</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createProviderFromFnOrClass">createProviderFromFnOrClass</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isFunction">isFunction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isObject">isObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isUpperCase">isUpperCase</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-toString">toString</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ownKeys">ownKeys</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">utils/request</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ExistsRequest">ExistsRequest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-GetRequest">GetRequest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-PostRequest">PostRequest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-UrlParser">UrlParser</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ParseStringToXml">ParseStringToXml</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">utils/view</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/view/LayoutHelpers.js~BaseLayoutHelper.html">BaseLayoutHelper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/view/LayoutHelpers.js~DockedLayoutHelper.html">DockedLayoutHelper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/view/LayoutHelpers.js~FullSizeLayoutHelper.html">FullSizeLayoutHelper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/view/LayoutHelpers.js~TraditionalLayoutHelper.html">TraditionalLayoutHelper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/view/RenderableHelper.js~RenderableHelper.html">RenderableHelper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/view/SizeResolver.js~SizeResolver.html">SizeResolver</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/view/Utils.js~Utils.html">Utils</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/data/PrioritisedArray.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/**



 @author: Tom Clement (tjclement)
 @license NPOSL-3.0
 @copyright Bizboard, 2015

 */

import extend                       from &apos;lodash/extend.js&apos;;
import EventEmitter                 from &apos;eventemitter3&apos;;
import {Injection}                  from &apos;../utils/Injection.js&apos;;
import {ObjectHelper}               from &apos;../utils/ObjectHelper.js&apos;;
import {DataSource}                 from &apos;./DataSource.js&apos;;
import {Throttler}                  from &apos;../utils/Throttler.js&apos;;

/**
 * An array of two-way bound data Models that are automatically synced with the currently used DataSource
 */
export class PrioritisedArray extends Array {

    /**
     * The number of items in the (synchronized or local) data set.
     * @returns {Number}
     */
    get length() {
        /* Extending Array does not work fluently yet. The length property always returns 0,
         * regardless of how many entries are in the array. We&apos;ll override the length prop to determine
         * the amount of enumerable properties in our PrioritisedArray instead of using the built-in length property.
         */
        return Object.keys(this).length;
    }

    /**
     * A setter on the length is necessary because internal methods of Array modify the lngth. It won&apos;t change the length thoough
     * @param {Number} value
     * @returns {*}
     */
    set length(value) {
        return value;
    }

    /**
     *
     * @param {Function} dataType DataType of the models being added to the PrioritisedArray.
     * @param {DataSource} [dataSource] dataSource to load the models from. If none is given, a new DataSource is made with a path guessed from
     * the model&apos;s DataType name.
     * @param {Snapshot} [dataSnapshot] snapshot already containing model data. Prevents initial subscription on all values in the DataSource.
     * @param {Object} [options] options to pass to the dataSource if none is provided and a new one is constructed.
     * @param {Object} [modelOptions] options to merge into the construction of every new Model.
     * @returns {PrioritisedArray} PrioritisedArray instance.
     */
    constructor(dataType, dataSource = null, dataSnapshot = null, options = null, modelOptions = {}) {
        super();
        /**** Callbacks ****/
        this._valueChangedCallback = null;
        this._ids = {};

        /**** Private properties ****/
        this._dataType = dataType;
        this._dataSource = dataSource;
        this._isBeingReordered = false;
        this._modelOptions = modelOptions;
        /* Flag to determine when we&apos;re reordering so we don&apos;t listen to move updates */
        this._eventEmitter = new EventEmitter();
        this._childAddedThrottler = new Throttler(1, true, this, true);
        this._overrideChildAddedForId = null;

        /* Bind all local methods to the current object instance, so we can refer to &quot;this&quot;
         * in the methods as expected, even when they&apos;re called from event handlers.        */
        ObjectHelper.bindAllMethods(this, this);

        /* Hide all private properties (starting with &apos;_&apos;) and methods from enumeration,
         * so when you do for( in ), only actual data properties show up. */
        ObjectHelper.hideMethodsAndPrivatePropertiesFromObject(this);

        /* Hide the priority field from enumeration, so we don&apos;t save it to the dataSource. */
        ObjectHelper.hidePropertyFromObject(Object.getPrototypeOf(this), &apos;length&apos;);

        /* If no dataSource is given, create own one with guessed path */
        if (!dataSource) {
            /* The this._name property can be set by Arva&apos;s babel-plugin-transform-runtime-constructor-name plugin.
             * This allows Arva code to be minified and mangled without losing automated model name resolving.
             * If the plugin is not set up to run, which is done e.g. when not minifying your code, we default back to the runtime constructor name. */
            let path = this.constructor._name || Object.getPrototypeOf(this).constructor.name;
            /* Retrieve dataSource from the DI context */
            dataSource = Injection.get(DataSource);

            if (options) {
                dataSource = dataSource.child(options.path || path, options);
            } else {
                dataSource = dataSource.child(path);
            }

            this._dataSource = dataSource;
        }

        /* If a snapshot is present use it, otherwise generate one by subscribing to the dataSource one time. */
        if (dataSnapshot) {
            this._buildFromSnapshot(dataSnapshot);
        } else {
            this._buildFromDataSource(dataSource);
        }
    }

    /**
     * Subscribes to events emitted by this PrioritisedArray.
     * @param {String} event One of the following Event Types: &apos;value&apos;, &apos;child_changed&apos;, &apos;child_moved&apos;, &apos;child_removed&apos;.
     * @param {Function} handler Function that is called when the given event type is emitted.
     * @param {Object} context Optional: context of &apos;this&apos; inside the handler function when it is called.
     * @returns {void}
     */
    on = (event, handler, context) =&gt; {
        /* If we&apos;re already ready, fire immediately */
        if ((event === &apos;ready&apos; || event === &apos;value&apos;) &amp;&amp; this._dataSource &amp;&amp; this._dataSource.ready) {
            handler.call(context, this);
        }

        /* If we already have children stored locally when the subscriber calls this method,
         * fire their callback for all pre-existing children. */
        if (event === &apos;child_added&apos;) {

            for (let i = 0; i &lt; this.length; i++) {
                this._childAddedThrottler.add(() =&gt; {
                    let model = this[i];
                    let previousSiblingID = i &gt; 0 ? this[i - 1].id : null;
                    handler.call(context, model, previousSiblingID);
                });
            }
        }

        this._eventEmitter.on(event, handler, context);
    }

    /**
     * Subscribes to the given event type exactly once; it automatically unsubscribes after the first time it is triggered.
     * @param {String} event One of the following Event Types: &apos;value&apos;, &apos;child_changed&apos;, &apos;child_moved&apos;, &apos;child_removed&apos;.
     * @param {Function} [handler] Function that is called when the given event type is emitted.
     * @param {Object} [context] context of &apos;this&apos; inside the handler function when it is called.
     * @returns {Promise} If no callback function provided, a promise that resolves once the event has happened
     */
    once(event, handler, context = this) {
        if (!handler) {
            return new Promise((resolve) =&gt; this.once(event, resolve, context));
        }
        return this.on(event, function onceWrapper() {
            this.off(event, onceWrapper, context);
            handler.call(context, ...arguments);
        }, this);
    }

    /**
     * Removes subscription to events emitted by this PrioritisedArray. If no handler or context is given, all handlers for
     * the given event are removed. If no parameters are given at all, all event types will have their handlers removed.
     * @param {String} event One of the following Event Types: &apos;value&apos;, &apos;child_changed&apos;, &apos;child_moved&apos;, &apos;child_removed&apos;.
     * @param {Function} handler Function to remove from event callbacks.
     * @param {Object} context Object to bind the given callback function to.
     * @returns {void}
     */
    off(event, handler, context) {
        if (event &amp;&amp; (handler || context)) {
            this._eventEmitter.removeListener(event, handler, context);
        } else {
            this._eventEmitter.removeAllListeners(event);
        }
    }

    /**
     * Adds a model instance to the rear of the PrioritisedArray, and emits a &apos;child_added&apos; and possibly &apos;new_child&apos; event after successful addition.
     * @param {Model|Object} model Instance of a Model.
     * @param {String} prevSiblingId ID of the model preceding the one that will be added.
     * @returns {Object} Same model as the one originally passed as parameter.
     */
    add(model, prevSiblingId = null) {
        if (model instanceof this._dataType) {
            if (this.findIndexById(model.id) &lt; 0) {

                if (prevSiblingId) {
                    let newPosition = this.findIndexById(prevSiblingId) + 1;
                    this.insertAt(model, newPosition);
                } else {
                    this.push(model);
                }

                /* If we&apos;ve already received an on(&apos;value&apos;) result, this child addition is
                 * a new entry that wasn&apos;t on the dataSource before. */
                if (this._dataSource.ready) {
                    this._eventEmitter.emit(&apos;new_child&apos;, model, prevSiblingId);
                }

                this._eventEmitter.emit(&apos;child_added&apos;, model, prevSiblingId);
                return model;
            }
        } else if (model instanceof Object) {
            /* Let&apos;s try to parse the object using property reflection */
            var options = {dataSource: this._dataSource};
            /* Prevent child_added from being fired immediately when the model is created by creating a promise that resolves
             * the ID that shouldn&apos;t be synced twice
             */

            this._overrideChildAddedForId = this.once(&apos;local_child_added&apos;);
            let newModel = new this._dataType(null, model, extend({}, this._modelOptions, options));

            this.add(newModel);
            /* Remove lock */
            this._eventEmitter.emit(&apos;local_child_added&apos;, newModel);
            this._overrideChildAddedForId = null;
            return newModel;
        } else {
            /* TODO: change to throw exception */
            console.log(&apos;Tried to append an object that is not the same type as the one this PrioritisedArray was created with.&apos;);
        }

        /* Return model so we can do this: let newModel = PrioArray.add(new Model()); newModel.someProperty = true; */
        return null;
    }


    /**
     * Inserts a model instance at the given position of the PrioritisedArray, and recalculates the priority (position)
     * of all models after the inserted position.
     * @param {Model} model Subclass of Model
     * @param {Number} position Zero-based index where to put the new model instance.
     * @returns {Object} Same model as the one originally passed as parameter.
     */
    insertAt(model, position) {
        if (model instanceof this._dataType) {
            for (let i = position; i &lt; this.length; i++) {
                /* Increase the index of items further on in the prio array */
                this._ids[this[i].id]++;
            }
            this.splice(position, 0, model);
            this._ids[model._id] = position;
        } else {
            /* TODO: change to throw exception */
            console.log(&apos;Tried to append an object that is not the same type as the PrioritisedArray was created with.&apos;);
        }

        /* Return model so we can do this: let newModel = PrioArray.add(new Model()); newModel.someProperty = true; */
        return model;
    }

    /**
     * Adds a model or object to the end of the list.
     * @param {Object|Model} model
     * @returns {Model} The newly inserted model
     */
    push(model){
        return this.insertAt(model, this.length);
    }

    /**
     * Removes the model instance at the given position. Does not remove the model from the datasource, to do that
     * call model.remove() directly, or PrioArray[index].remove().
     * @param {Number} position Index in the PrioritisedArray of the model to remove.
     * @returns {void}
     */
    remove(position) {
        /*
         * TODO: Beware, there might be hard to reproduce prone to errors going on sometimes when deleting many things at once
         * Sometimes, there is an inconsistent state, but I haven&apos;t been able to figure out how that happens. /Karl
         */
        if(this.length === 1){
            this._ids = {};
        } else {
            for (let i = position; i &lt; this.length; i++) {
                /* Decrease the index of items further on in the prio array */
                if(!this._ids[this[i].id] &amp;&amp; this._ids[this[i].id] !== 0){
                    console.log(&quot;Internal error, decreasing index of non-existing id. For ID: &quot; + this[i].id);
                }
                this._ids[this[i].id]--;
            }
        }
        this.splice(position, 1);
    }



    /**
     * Return the position of model&apos;s id, saved in an associative array
     * @param {Number} id Id field of the model we&apos;re looking for
     * @returns {Number} Zero-based index if found, -1 otherwise
     * @private
     */
    findIndexById(id) {
        let position = this._ids[id];
        return (position == undefined || position == null) ? -1 : position;
    }


    /**
     * Finds an item based on its Id in the datasource.
     * @param id
     * @returns {Model}
     */
    findById(id) {
        return this[this.findIndexById(id)];
    }


    /**
     * Interprets all childs of a given snapshot as instances of the given data type for this PrioritisedArray,
     * and attempts to instantiate new model instances based on these sub-snapshots. It adds them to the
     * PrioritisedArray, which also assigns their priority based on their inserted position.
     * @param {Snapshot} dataSnapshot Snapshot to build the PrioritisedArray from.
     * @returns {void}
     * @private
     */
    _buildFromSnapshot(dataSnapshot) {

        let numChildren = dataSnapshot.numChildren(), currentChild = 1;

        /* If there is no data at this point yet, fire a ready event */
        if (numChildren === 0) {
            this._dataSource.ready = true;
            this._eventEmitter.emit(&apos;ready&apos;);
            this._eventEmitter.emit(&apos;value&apos;, this);
        }

        dataSnapshot.forEach(function (child) {
            this._childAddedThrottler.add(function (child) {
                /* Create a new instance of the given data type and prefill it with the snapshot data. */
                let options = {dataSnapshot: child};
                let childRef = this._dataSource.child(child.key);

                /* whenever the ref() is a datasource, we can bind that source to the model.
                 * whenever it&apos;s not a datasource, we assume the model should instantiate a new
                 * datasource to bind the model */

                if (childRef instanceof DataSource) {
                    options.dataSource = childRef;
                } else {
                    var rootPath = dataSnapshot.ref().root().toString();
                    options.path = dataSnapshot.ref().toString().replace(rootPath, &apos;/&apos;);
                }

                let newModel = new this._dataType(child.key, child.val(), extend({}, this._modelOptions, options));
                this.add(newModel);

                /* If this is the last child, fire a ready event */
                if (currentChild++ === numChildren) {
                    this._dataSource.ready = true;
                    this._eventEmitter.emit(&apos;ready&apos;);
                    this._eventEmitter.emit(&apos;value&apos;, this);
                }

            }.bind(this, child));
        }.bind(this))
    }

    /**
     * Clones a dataSource (to not disturb any existing callbacks defined on the original) and uses it
     * to get a dataSnapshot which is used in _buildSnapshot to build our array.
     * @param {DataSource} dataSource DataSource to subscribe to for building the PrioritisedArray.
     * @returns {void}
     * @private
     */
    _buildFromDataSource(dataSource) {
        dataSource.once(&apos;value&apos;, (dataSnapshot) =&gt; {
            this._buildFromSnapshot(dataSnapshot);
            this._registerCallbacks(dataSource);
        });
    }

    /**
     * Registers the added, moved, changed, and removed callbacks to the given DataSource.
     * @param {DataSource} dataSource DataSource to register callbacks on.
     * @return {void}
     * @private
     */
    _registerCallbacks(dataSource) {
        dataSource.on(&apos;child_added&apos;, this._doOnceReady(this._onChildAdded));
        dataSource.on(&apos;child_moved&apos;, this._doOnceReady(this._onChildMoved));
        dataSource.on(&apos;child_changed&apos;, this._doOnceReady(this._onChildChanged));
        dataSource.on(&apos;child_removed&apos;, this._doOnceReady(this._onChildRemoved));
    }

    _doOnceReady(callback) {
        return (...otherArgs) =&gt; {
            if (!this._dataSource.ready) {
                this.once(&apos;ready&apos;, () =&gt; {
                    return callback(...otherArgs)
                });
            } else {
                return callback(...otherArgs)
            }
        }
    }

    /**
     * Called by dataSource when a new child is added.
     * @param {Snapshot} snapshot Snapshot of the added child.
     * @param {String} prevSiblingId ID of the model preceding the added model.
     * @returns {void}
     * @private
     */
    _onChildAdded(snapshot, prevSiblingId) {
        let id = snapshot.key;
        if (this._overrideChildAddedForId) {
            this._overrideChildAddedForId.then((newModel) =&gt; {
                /* If the override is concerning another id, then go ahead and make the _onChildAdded */
                if (newModel.id !== id) {
                    this._onChildAdded(snapshot, prevSiblingId)
                }
                /* Otherwise, don&apos;t recreate the same model twice */
            });
            return;
        }

        /* Skip addition if an item with identical ID already exists. */
        let previousPosition = this.findIndexById(id);
        if (previousPosition &gt;= 0) {
            return;
        }

        let model = new this._dataType(id, null, extend({}, this._modelOptions, {
            dataSnapshot: snapshot
        }));
        this.add(model, prevSiblingId);

        if (!this._dataSource.ready) {
            this._dataSource.ready = true;
            this._eventEmitter.emit(&apos;ready&apos;);
        }
        this._eventEmitter.emit(&apos;value&apos;, this);
    }

    /**
     * Called by dataSource when a child is changed.
     * @param {Snapshot} snapshot Snapshot of the added child.
     * @param {String} prevSiblingId ID of the model preceding the added model.
     * @returns {void}
     * @private
     */
    _onChildChanged(snapshot, prevSiblingId) {
        let id = snapshot.key;

        let previousPosition = this.findIndexById(id);
        if (previousPosition &lt; 0) {
            /* The model doesn&apos;t exist, so we won&apos;t emit a changed event. */
            return;
        }

        let model = this[previousPosition];
        model._onChildValue(snapshot, prevSiblingId);
        let newPosition = this.findIndexById(prevSiblingId) + 1;

        this._moveItem(previousPosition, newPosition, model);

        this._eventEmitter.emit(&apos;child_changed&apos;, model, prevSiblingId);
        this._eventEmitter.emit(&apos;value&apos;, this);
    }

    /**
     * Called by dataSource when a child is moved, which changes its priority.
     * @param {Snapshot} snapshot Snapshot of the added child.
     * @param {String} prevSiblingId ID of the model preceding the added model.
     * @returns {void}
     * @private
     */
    _onChildMoved(snapshot, prevSiblingId) {
        /* Ignore priority updates whilst we&apos;re reordering to avoid floods */
        if (!this._isBeingReordered) {

            let id = snapshot.key;
            let previousPosition = this.findIndexById(id);
            let newPosition = this.findIndexById(prevSiblingId) + 1;
            let tempModel = this[previousPosition];
            this._moveItem(previousPosition, newPosition, tempModel);

            let model = this[newPosition];

            this._eventEmitter.emit(&apos;child_moved&apos;, model, previousPosition);
            this._eventEmitter.emit(&apos;value&apos;, this);
        }
    }

    _moveItem(previousPosition, newPosition, modelToMove) {
        this._ids[modelToMove._id] = newPosition;
        /* Update the positions of things coming inbetween */
        for (let positionAhead = previousPosition; positionAhead &lt; newPosition; positionAhead++) {
            this._ids[this[positionAhead].id]--;
        }
        for (let positionBefore = newPosition; positionBefore &lt; previousPosition; positionBefore++) {
            this._ids[this[positionBefore].id]++;
        }

        if (previousPosition === newPosition) {
            this[newPosition] = modelToMove;
        } else {
            this.splice(previousPosition, 1);
            this.splice(newPosition, 0, modelToMove);
        }
    }
    /**
     * Called by dataSource when a child is removed.
     * @param {Snapshot} oldSnapshot Snapshot of the added child.
     * @returns {void}
     * @private
     */
    _onChildRemoved(oldSnapshot) {
        /* TODO: figure out if we can use the snapshot&apos;s priority as our array index reliably, to avoid big loops. */
        let id = oldSnapshot.key;
        let position = this.findIndexById(id);
        let model = this[position];

        if (position !== -1) {
            this.remove(position);
            delete this._ids[id];

            this._eventEmitter.emit(&apos;child_removed&apos;, model);
            this._eventEmitter.emit(&apos;value&apos;, this);
        }
    }

}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.0-alpha)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
